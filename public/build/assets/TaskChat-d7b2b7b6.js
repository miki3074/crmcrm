import{r as c,x as H,y as K,o as a,c as n,a as e,F as L,e as T,t as d,b as p,d as v,h as R,v as S,E as V,U as A,g as U,f as M,D as $}from"./app-f33d6ccc.js";const E={class:"rounded-2xl border bg-white dark:bg-gray-800 p-5 mt-8"},F={class:"space-y-4 max-h-80 overflow-y-auto pr-1 custom-scrollbar"},Z={class:"flex-1"},q={class:"flex items-center gap-2 mb-1"},O={class:"text-sm font-bold text-gray-900 dark:text-white"},G={class:"text-xs text-gray-500"},J=["onClick"],P={key:0,class:"mb-1 pl-2 border-l-2 border-indigo-300 dark:border-indigo-700 text-xs text-gray-500 bg-gray-50 dark:bg-gray-700/50 py-1 rounded-r"},Q={class:"font-medium flex items-center gap-1"},W={class:"truncate opacity-80 italic"},X=["innerHTML"],Y={key:0,class:"text-sm text-gray-500"},ee={key:0,class:"mt-4 relative"},te={key:0,class:"flex items-center justify-between bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 rounded-t-lg px-3 py-2 text-xs mb-[-1px] z-10 relative"},se={class:"flex flex-col overflow-hidden mr-2"},oe={class:"font-semibold text-indigo-700 dark:text-indigo-300 flex items-center gap-1"},ae={class:"truncate text-gray-500 dark:text-gray-400 max-w-xs"},ne=["placeholder","onKeydown"],re={class:"mt-2 flex justify-end"},ie=["disabled"],le={key:1,class:"absolute bottom-full left-0 mb-2 bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg shadow-xl w-64 max-h-48 overflow-y-auto z-50"},de=["onClick"],ce={class:"w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold"},ue={key:1,class:"mt-3 text-xs text-gray-500"},xe={__name:"TaskChat",props:{taskId:{type:Number,required:!0},canChat:{type:Boolean,default:!0},members:{type:Array,default:()=>[]}},setup(y){const x=y,f=c([]),l=c(""),g=c(!1),w=c(""),m=c([]),j=c(0),i=c(null),b=c(null);let k=null;const _=async()=>{const{data:o}=await M.get(`/api/tasks/${x.taskId}/comments`,{withCredentials:!0});f.value=o},B=async()=>{if(!l.value.trim())return;await M.get("/sanctum/csrf-cookie");const o={body:l.value,parent_id:i.value?i.value.id:null};await M.post(`/api/tasks/${x.taskId}/comments`,o,{withCredentials:!0}),l.value="",I(),await _()},N=o=>{i.value=o,$(()=>{var t;(t=b.value)==null||t.focus()})},I=()=>{i.value=null},C=o=>{const t=l.value,r=o.target.selectionStart;if(j.value=r,t[r-1]==="@"){g.value=!0,w.value="",m.value=x.members;return}if(g.value){const u=t.slice(0,r).match(/@([а-яА-Яa-zA-Z0-9_]*)$/);if(!u){g.value=!1;return}w.value=u[1].toLowerCase(),m.value=x.members.filter(h=>h.name.toLowerCase().includes(w.value))}},z=o=>{const t=l.value;l.value=t.replace(/@([а-яА-Яa-zA-Z0-9_]*)$/,"@"+o.name.replace(/\s+/g,"_")+" "),g.value=!1,$(()=>{var r;return(r=b.value)==null?void 0:r.focus()})},D=o=>o?o.replace(/@([\p{L}0-9_]+)/gu,(t,r)=>`<span class="text-indigo-600 font-semibold">@${r.replace(/_/g," ")}</span>`):"";return H(async()=>{await _(),k=setInterval(_,1e4)}),K(()=>{k&&clearInterval(k)}),(o,t)=>{var r;return a(),n("div",E,[t[5]||(t[5]=e("div",{class:"mb-4 flex items-center justify-between"},[e("h3",{class:"text-sm font-semibold text-gray-900 dark:text-white"},"Комментарии")],-1)),e("div",F,[(a(!0),n(L,null,T(f.value,s=>{var u,h;return a(),n("div",{key:s.id,class:"flex gap-3 group"},[e("div",Z,[e("div",q,[e("div",O,d(((u=s.user)==null?void 0:u.name)??"—"),1),e("div",G,d(new Date(s.created_at).toLocaleString()),1),y.canChat?(a(),n("button",{key:0,onClick:ge=>N(s),class:"ml-2 text-xs text-indigo-500 opacity-0 group-hover:opacity-100 transition-opacity hover:underline flex items-center gap-1",title:"Ответить"},t[1]||(t[1]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"9 17 4 12 9 7"}),e("path",{d:"M20 18v-2a4 4 0 0 0-4-4H4"})],-1),p(" Ответить ",-1)]),8,J)):v("",!0)]),s.parent?(a(),n("div",P,[e("div",Q,[t[2]||(t[2]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6m-6-6l6-6"})],-1)),p(" "+d((h=s.parent.user)==null?void 0:h.name)+": ",1)]),e("div",W,d(s.parent.body),1)])):v("",!0),e("div",{class:"text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap leading-relaxed",innerHTML:D(s.body)},null,8,X)])])}),128)),f.value.length?v("",!0):(a(),n("div",Y,"Пока нет сообщений."))]),y.canChat?(a(),n("div",ee,[i.value?(a(),n("div",te,[e("div",se,[e("span",oe,[t[3]||(t[3]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("polyline",{points:"9 17 4 12 9 7"}),e("path",{d:"M20 18v-2a4 4 0 0 0-4-4H4"})],-1)),p(" В ответ "+d((r=i.value.user)==null?void 0:r.name),1)]),e("span",ae,d(i.value.body),1)]),e("button",{onClick:I,class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"},t[4]||(t[4]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)]))])):v("",!0),R(e("textarea",{ref_key:"textareaRef",ref:b,"onUpdate:modelValue":t[0]||(t[0]=s=>l.value=s),rows:"2",placeholder:i.value?"Напишите ответ...":"Напишите комментарий…",class:V(["w-full border bg-white/80 dark:bg-gray-700 px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all",i.value?"rounded-b-lg border-t-0":"rounded-lg"]),onInput:C,onClick:C,onKeyup:C,onKeydown:A(U(B,["ctrl"]),["enter"])},null,42,ne),[[S,l.value]]),e("div",re,[e("button",{onClick:B,disabled:!l.value.trim(),class:"px-4 py-2 rounded-lg bg-indigo-600 text-white disabled:opacity-40 text-sm font-medium hover:bg-indigo-700 transition"},d(i.value?"Ответить":"Отправить"),9,ie)]),g.value&&m.value.length?(a(),n("div",le,[(a(!0),n(L,null,T(m.value,s=>(a(),n("div",{key:s.id,class:"px-3 py-2 cursor-pointer hover:bg-indigo-50 dark:hover:bg-gray-600 text-sm flex items-center gap-2",onClick:u=>z(s)},[e("div",ce,d(s.name[0]),1),p(" "+d(s.name),1)],8,de))),128))])):v("",!0)])):(a(),n("div",ue," У вас нет прав на участие в чате. "))])}}};export{xe as _};
