import{r as g,x as H,o as r,c as n,a as e,F as M,e as T,t as u,E as K,d as y,h as L,v as O,K as P,i as W,b as C,f,Q as X,j as Y,y as ee,k as te,I as se,J as ae,O as oe,g as re,D as V}from"./app-e92293fe.js";import{_ as ne}from"./_plugin-vue_export-helper-c27b6911.js";const le={class:"mt-6"},ie={key:0,class:"space-y-2"},de=["checked","onChange"],ue={key:0,class:"text-sm text-gray-500"},ce={key:1,class:"text-gray-500"},ge={key:2,class:"fixed inset-0 bg-black/50 flex items-center justify-center"},pe={class:"bg-white rounded p-6 w-96"},ve={key:0,class:"text-sm text-rose-600 mb-2"},me=["value"],be=["value"],ye=["value"],he={class:"flex items-center gap-2 mb-2"},xe={class:"flex justify-end gap-2"},et={__name:"TaskChecklists",props:{taskId:{type:Number,required:!0},executors:{type:Array,default:()=>[]},responsibles:{type:Array,default:()=>[]},creator:{type:Object,default:()=>null}},setup(v){const m=g(""),j=v,k=g([]),h=g(!1),c=g(!1),d=g({title:"",assigned_to:[],important:!1,files:[]}),x=async()=>{h.value=!0;try{const{data:i}=await f.get(`/api/tasks/${j.taskId}/checklists`);k.value=i}finally{h.value=!1}},w=async()=>{var a,s;m.value="";const i=new FormData;i.append("title",d.value.title),d.value.assigned_to&&i.append("assigned_to",d.value.assigned_to),i.append("important",d.value.important?1:0);for(let b of d.value.files)i.append("files[]",b);try{await f.post(`/api/tasks/${j.taskId}/checklists`,i,{headers:{"Content-Type":"multipart/form-data"}}),c.value=!1,d.value={title:"",assigned_to:"",important:!1,files:[]},await x()}catch(b){if(((a=b.response)==null?void 0:a.status)===422){const $=b.response.data;m.value=$.message||((s=Object.values($.errors||{})[0])==null?void 0:s[0])||"Ошибка при создании пункта чек-листа."}else m.value="Не удалось создать пункт чек-листа."}},z=async i=>{await f.patch(`/api/checklists/${i.id}/toggle`),await x()};return H(x),(i,a)=>(r(),n("div",le,[a[10]||(a[10]=e("h3",{class:"text-lg font-semibold mb-2"},"Чек-листы",-1)),k.value.length?(r(),n("ul",ie,[(r(!0),n(M,null,T(k.value,s=>(r(),n("li",{key:s.id,class:"flex items-center gap-2"},[e("input",{type:"checkbox",checked:s.completed,onChange:b=>z(s)},null,40,de),e("span",{class:K({"font-bold text-red-600":s.important})},u(s.title),3),s.assignee?(r(),n("span",ue,"("+u(s.assignee.name)+")",1)):y("",!0)]))),128))])):(r(),n("p",ce,"Нет чек-листов")),e("button",{class:"mt-4 px-4 py-2 bg-indigo-600 text-white rounded",onClick:a[0]||(a[0]=s=>c.value=!0)}," Добавить чек-лист "),c.value?(r(),n("div",ge,[e("div",pe,[a[8]||(a[8]=e("h4",{class:"text-lg font-semibold mb-2"},"Новый пункт чек-листа",-1)),m.value?(r(),n("p",ve,u(m.value),1)):y("",!0),L(e("input",{required:"","onUpdate:modelValue":a[1]||(a[1]=s=>d.value.title=s),type:"text",placeholder:"Название",class:"w-full border mb-2 p-2"},null,512),[[O,d.value.title]]),a[9]||(a[9]=e("label",{class:"block text-sm"},"Ответственный",-1)),L(e("select",{"onUpdate:modelValue":a[2]||(a[2]=s=>d.value.assigned_to=s),class:"w-full border mb-2 p-2"},[a[6]||(a[6]=e("option",{value:""},"—",-1)),(r(!0),n(M,null,T(v.executors,s=>(r(),n("option",{key:"exec-"+s.id,value:s.id},u(s.name),9,me))),128)),(r(!0),n(M,null,T(v.responsibles,s=>(r(),n("option",{key:"resp-"+s.id,value:s.id},u(s.name),9,be))),128)),v.creator?(r(),n("option",{key:0,value:v.creator.id},u(v.creator.name),9,ye)):y("",!0)],512),[[P,d.value.assigned_to]]),e("label",he,[L(e("input",{type:"checkbox","onUpdate:modelValue":a[3]||(a[3]=s=>d.value.important=s)},null,512),[[W,d.value.important]]),a[7]||(a[7]=C(" Важно ",-1))]),e("input",{type:"file",multiple:"",onChange:a[4]||(a[4]=s=>d.value.files=Array.from(s.target.files)),class:"mb-4"},null,32),e("div",xe,[e("button",{onClick:a[5]||(a[5]=s=>c.value=!1),class:"px-3 py-1 border"},"Отмена"),e("button",{onClick:w,class:"px-3 py-1 bg-indigo-600 text-white"},"Сохранить")])])])):y("",!0)]))}};const fe={class:"flex flex-col h-[600px] bg-gray-50 dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm"},ke={class:"px-5 py-3 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center shadow-sm z-10"},we={class:"text-xs text-gray-400 font-medium"},_e={key:0,class:"flex flex-col items-center justify-center h-full text-gray-400 text-sm opacity-60"},Ce={class:"flex-shrink-0 mt-1"},$e={class:"flex-1 min-w-0"},Me={class:"flex items-baseline gap-2 mb-0.5"},Te={class:"text-sm font-bold text-gray-900 dark:text-gray-100 cursor-pointer hover:underline"},je={class:"text-[10px] text-gray-400"},Ie={class:"relative bg-white dark:bg-gray-800 p-3 rounded-2xl rounded-tl-none border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow"},Be={key:0,class:"mb-2 pl-3 border-l-4 border-indigo-200 dark:border-indigo-700/50 py-1 bg-gray-50 dark:bg-gray-700/30 rounded-r-lg"},Le={class:"flex items-center gap-1 text-xs font-semibold text-indigo-600 dark:text-indigo-400"},ze={class:"text-xs text-gray-500 truncate mt-0.5 max-w-[200px]"},Ve=["innerHTML"],De={class:"absolute -top-3 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200"},Ae=["onClick"],Ne=["onClick"],Se={key:0,class:"bg-white dark:bg-gray-800 p-4 border-t border-gray-200 dark:border-gray-700 relative z-20"},Ue={key:0,class:"absolute bottom-full left-4 right-4 mb-2 bg-indigo-50 dark:bg-gray-700 p-3 rounded-lg border border-indigo-100 dark:border-indigo-500/30 shadow-lg flex justify-between items-center z-30"},He={class:"flex items-center gap-3 overflow-hidden"},Ke={class:"flex flex-col text-sm"},Oe={class:"font-bold text-indigo-700 dark:text-indigo-300"},Re={class:"text-gray-500 dark:text-gray-400 truncate max-w-xs text-xs"},qe={class:"relative flex items-end gap-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-xl p-2 focus-within:ring-2 focus-within:ring-indigo-500/50 focus-within:border-indigo-500 transition-all"},Ee=["placeholder","onKeydown"],Fe=["disabled"],Ze={key:0,class:"absolute bottom-full left-4 mb-2 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-xl shadow-2xl w-64 max-h-56 overflow-y-auto z-50 custom-scrollbar"},Je=["onClick"],Qe={class:"w-7 h-7 rounded-full bg-gradient-to-tr from-indigo-100 to-purple-100 text-indigo-700 flex items-center justify-center text-xs font-bold shadow-sm"},Ge={class:"font-medium text-gray-700 dark:text-gray-200"},Pe={key:1,class:"p-4 bg-gray-50 dark:bg-gray-900 border-t dark:border-gray-700 text-center text-xs text-gray-500 italic"},We={__name:"TaskChat",props:{taskId:{type:Number,required:!0},canChat:{type:Boolean,default:!0},members:{type:Array,default:()=>[]}},setup(v){const m=v,j=X(),k=Y(()=>j.props.auth.user),h=g([]),c=g(""),d=g(!1),x=g(""),w=g([]),z=g(0),i=g(null),a=g(null);let s=null;const b=async()=>{try{const{data:o}=await f.get(`/api/tasks/${m.taskId}/comments`,{withCredentials:!0});h.value=o}catch(o){console.error("Ошибка загрузки комментариев",o)}},$=async()=>{if(!c.value.trim())return;await f.get("/sanctum/csrf-cookie");const o={body:c.value,parent_id:i.value?i.value.id:null};try{await f.post(`/api/tasks/${m.taskId}/comments`,o,{withCredentials:!0}),c.value="",A(),await b(),D()}catch{alert("Не удалось отправить сообщение")}},R=async o=>{confirm("Удалить сообщение?")&&(await f.delete(`/api/task-comments/${o}`),await b())},I=g(null),D=()=>{V(()=>{I.value&&(I.value.scrollTop=I.value.scrollHeight)})},q=o=>{i.value=o,V(()=>{var t;return(t=a.value)==null?void 0:t.focus()})},A=()=>i.value=null,N=o=>{o.target.style.height="auto",o.target.style.height=o.target.scrollHeight+"px";const t=c.value,p=o.target.selectionStart;if(z.value=p,t[p-1]==="@"){d.value=!0,x.value="",w.value=m.members;return}if(d.value){const _=t.slice(0,p).match(/@([а-яА-Яa-zA-Z0-9_]*)$/);if(!_){d.value=!1;return}x.value=_[1].toLowerCase(),w.value=m.members.filter(B=>B.name.toLowerCase().includes(x.value))}},E=o=>{const t=c.value;c.value=t.replace(/@([а-яА-Яa-zA-Z0-9_]*)$/,"@"+o.name.replace(/\s+/g,"_")+" "),d.value=!1,V(()=>{var p;return(p=a.value)==null?void 0:p.focus()})},F=o=>o?o.replace(/@([\p{L}0-9_]+)/gu,(t,p)=>`<span class="text-indigo-600 font-semibold bg-indigo-50 px-1 rounded">@${p.replace(/_/g," ")}</span>`):"",Z=o=>o?o.split(" ").map(t=>t[0]).join("").slice(0,2).toUpperCase():"?",J=o=>{const t=["bg-red-100 text-red-600","bg-blue-100 text-blue-600","bg-green-100 text-green-600","bg-amber-100 text-amber-600","bg-purple-100 text-purple-600"];return t[o%t.length]},Q=o=>{const t=new Date(o),p=new Date;return t.toDateString()===p.toDateString()?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})};return H(async()=>{await b(),D(),s=setInterval(b,5e3)}),ee(()=>{s&&clearInterval(s)}),(o,t)=>{var p;return r(),n("div",fe,[e("div",ke,[t[1]||(t[1]=e("h3",{class:"font-bold text-gray-700 dark:text-gray-200 flex items-center gap-2"},[e("svg",{class:"w-5 h-5 text-indigo-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"})]),C(" Обсуждение задачи ")],-1)),e("span",we,u(h.value.length)+" сообщений",1)]),e("div",{ref_key:"commentsContainer",ref:I,class:"flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-gray-50/50 dark:bg-gray-900"},[h.value.length?y("",!0):(r(),n("div",_e,t[2]||(t[2]=[e("svg",{class:"w-12 h-12 mb-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1.5",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1),e("span",null,"Напишите первое сообщение...",-1)]))),(r(!0),n(M,null,T(h.value,l=>{var _,B,S,U;return r(),n("div",{key:l.id,class:"group flex gap-3 animate-fade-in-up"},[e("div",Ce,[e("div",{class:K(["w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shadow-sm",J(((_=l.user)==null?void 0:_.id)||0)])},u(Z((B=l.user)==null?void 0:B.name)),3)]),e("div",$e,[e("div",Me,[e("span",Te,u(((S=l.user)==null?void 0:S.name)||"Неизвестный"),1),e("span",je,u(Q(l.created_at)),1)]),e("div",Ie,[l.parent?(r(),n("div",Be,[e("div",Le,[t[3]||(t[3]=e("svg",{class:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6m-6-6l6-6"})],-1)),C(" "+u((U=l.parent.user)==null?void 0:U.name),1)]),e("div",ze,u(l.parent.body),1)])):y("",!0),e("div",{class:"text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap leading-relaxed break-words",innerHTML:F(l.body)},null,8,Ve),e("div",De,[v.canChat?(r(),n("button",{key:0,onClick:G=>q(l),class:"p-1.5 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-full shadow-sm text-gray-500 hover:text-indigo-600 hover:border-indigo-200 transition",title:"Ответить"},t[4]||(t[4]=[e("svg",{class:"w-3.5 h-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6m-6-6l6-6"})],-1)]),8,Ae)):y("",!0),k.value&&l.user_id===k.value.id?(r(),n("button",{key:1,onClick:G=>R(l.id),class:"p-1.5 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-full shadow-sm text-gray-500 hover:text-rose-600 hover:border-rose-200 transition",title:"Удалить"},t[5]||(t[5]=[e("svg",{class:"w-3.5 h-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)]),8,Ne)):y("",!0)])])])])}),128))],512),v.canChat?(r(),n("div",Se,[te(ae,{"enter-active-class":"transition ease-out duration-200","enter-from-class":"opacity-0 translate-y-2","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-150","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-2"},{default:se(()=>{var l;return[i.value?(r(),n("div",Ue,[e("div",He,[t[6]||(t[6]=e("div",{class:"w-1 bg-indigo-500 h-8 rounded-full"},null,-1)),e("div",Ke,[e("span",Oe,"Ответ "+u((l=i.value.user)==null?void 0:l.name),1),e("span",Re,u(i.value.body),1)])]),e("button",{onClick:A,class:"p-1 hover:bg-black/5 rounded-full text-gray-400 hover:text-gray-600 transition"},t[7]||(t[7]=[e("svg",{class:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))])):y("",!0)]}),_:1}),e("div",qe,[L(e("textarea",{ref_key:"textareaRef",ref:a,"onUpdate:modelValue":t[0]||(t[0]=l=>c.value=l),rows:"1",placeholder:i.value?`Ответить ${(p=i.value.user)==null?void 0:p.name}...`:"Написать сообщение...",class:"w-full bg-transparent border-none focus:ring-0 text-sm text-gray-800 dark:text-gray-200 resize-none max-h-32 py-2.5 px-2 custom-scrollbar",style:{"min-height":"40px"},onInput:N,onKeyup:N,onKeydown:oe(re($,["ctrl"]),["enter"])},null,40,Ee),[[O,c.value]]),e("button",{onClick:$,disabled:!c.value.trim(),class:"mb-1 p-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white rounded-lg shadow-sm transition-all transform hover:scale-105 active:scale-95 flex-shrink-0"},t[8]||(t[8]=[e("svg",{class:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})],-1)]),8,Fe)]),t[9]||(t[9]=e("div",{class:"text-[10px] text-gray-400 mt-2 ml-1 flex justify-between"},[e("span",null,[e("b",null,"Ctrl + Enter"),C(" для отправки")]),e("span",null,[C("Используйте "),e("b",null,"@"),C(" для упоминания")])],-1)),d.value&&w.value.length?(r(),n("div",Ze,[(r(!0),n(M,null,T(w.value,l=>(r(),n("div",{key:l.id,onClick:_=>E(l),class:"px-4 py-2.5 cursor-pointer hover:bg-indigo-50 dark:hover:bg-gray-700 text-sm flex items-center gap-3 border-b border-gray-50 dark:border-gray-700/50 last:border-0"},[e("div",Qe,u(l.name[0]),1),e("span",Ge,u(l.name),1)],8,Je))),128))])):y("",!0)])):(r(),n("div",Pe," Чат доступен только участникам задачи. "))])}}},tt=ne(We,[["__scopeId","data-v-a1f47505"]]);export{tt as T,et as _};
