import{m as p,p as _t,I as Ft,o as a,f as l,b as t,F as h,s as k,t as r,g,h as S,v as M,l as m,Q as Tt,k as I,a as B,u as Bt,w as Dt,Z as qt,d as b,n as D,x as Ut,e as zt,q as Nt}from"./app-048e9485.js";import{_ as Lt}from"./AuthenticatedLayout-aadadc44.js";import"./ApplicationLogo-47ea3b8a.js";import"./_plugin-vue_export-helper-c27b6911.js";const Ot={class:"rounded-2xl border bg-white dark:bg-gray-800 p-5 mt-8"},Et={class:"space-y-3 max-h-80 overflow-y-auto pr-1"},Ht={class:"flex-1"},Pt={class:"flex items-center gap-2"},Qt={class:"text-sm font-medium text-gray-900 dark:text-white"},Zt={class:"text-xs text-gray-500"},At=["onClick"],Gt={class:"mt-1 text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap"},Jt={key:0,class:"text-sm text-gray-500"},Kt={key:0,class:"mt-4"},Rt={class:"mt-2 flex justify-end"},Wt=["disabled"],Xt={key:1,class:"mt-3 text-xs text-gray-500"},Yt={__name:"TaskChat",props:{taskId:{type:Number,required:!0},canChat:{type:Boolean,default:!0}},setup(F){const _=F,x=p([]),v=p("");let y=null;const s=async()=>{const{data:u}=await m.get(`/api/tasks/${_.taskId}/comments`,{withCredentials:!0});x.value=u},f=async()=>{v.value.trim()&&(await m.get("/sanctum/csrf-cookie"),await m.post(`/api/tasks/${_.taskId}/comments`,{body:v.value},{withCredentials:!0}),v.value="",await s())},w=async u=>{await m.delete(`/api/task-comments/${u}`),await s()};return _t(async()=>{await s(),y=setInterval(s,1e4)}),Ft(()=>{y&&clearInterval(y)}),(u,$)=>(a(),l("div",Ot,[$[1]||($[1]=t("div",{class:"mb-4 flex items-center justify-between"},[t("h3",{class:"text-sm font-semibold text-gray-900 dark:text-white"},"Комментарии")],-1)),t("div",Et,[(a(!0),l(h,null,k(x.value,n=>{var C;return a(),l("div",{key:n.id,class:"flex gap-3"},[t("div",Ht,[t("div",Pt,[t("div",Qt,r(((C=n.user)==null?void 0:C.name)??"—"),1),t("div",Zt,r(new Date(n.created_at).toLocaleString()),1),u.$page.props.auth.user&&n.user&&n.user.id===u.$page.props.auth.user.id?(a(),l("button",{key:0,class:"ml-auto text-xs text-red-600 hover:underline",onClick:c=>w(n.id)},"Удалить",8,At)):g("",!0)]),t("div",Gt,r(n.body),1)])])}),128)),x.value.length?g("",!0):(a(),l("div",Jt,"Пока нет сообщений."))]),F.canChat?(a(),l("div",Kt,[S(t("textarea",{"onUpdate:modelValue":$[0]||($[0]=n=>v.value=n),rows:"2",placeholder:"Напишите комментарий…",class:"w-full rounded-lg border bg-white/80 dark:bg-gray-700 px-3 py-2 text-sm dark:text-white"},null,512),[[M,v.value]]),t("div",Rt,[t("button",{onClick:f,disabled:!v.value.trim(),class:"px-4 py-2 rounded-lg bg-indigo-600 text-white disabled:opacity-40"},"Отправить",8,Wt)])])):(a(),l("div",Xt," У вас нет прав на участие в чате этой задачи. "))]))}},te={class:"relative overflow-hidden"},ee={class:"relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-white"},se={class:"flex items-start gap-4"},ae={class:"flex-1"},le={class:"text-2xl sm:text-3xl font-semibold"},de={class:"mt-2 flex flex-wrap items-center gap-2 text-sm"},oe={class:"px-2 py-1 rounded-full bg-white/20"},re={class:"px-2 py-1 rounded-full bg-white/20"},ie={class:"px-2 py-1 rounded-full bg-white/20"},ne={class:"px-2 py-1 rounded-full bg-white/20"},ue={class:"px-2 py-1 rounded-full bg-white/20"},ge={class:"hidden sm:flex items-center gap-3"},ce=["href"],xe={key:0,class:"mt-3"},ve={key:1,class:"text-xs text-amber-600 mt-2"},pe={key:0},me={key:2,class:"text-sm mt-2 text-emerald-700"},ye={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-4 pb-10",style:{"margin-top":"3%"}},be={class:"grid grid-cols-1 lg:grid-cols-3 gap-4"},he={class:"lg:col-span-2 space-y-4"},ke={class:"rounded-2xl border bg-white dark:bg-gray-800 p-5"},_e={class:"grid grid-cols-1 sm:grid-cols-3 gap-4"},fe={class:"text-sm font-medium text-gray-900 dark:text-white"},we={class:"text-sm font-medium text-gray-900 dark:text-white"},$e={class:"mt-2"},Ce={class:"h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden"},je={class:"mt-1 text-xs text-gray-600 dark:text-gray-300"},Se={class:"flex mt-3 gap-1"},Ve=["onClick","title"],Ie={class:"rounded-2xl border bg-white dark:bg-gray-800 p-5"},Me={class:"flex items-center justify-between"},Fe={class:"flex items-center gap-2"},Te={key:0,class:"mt-4 grid grid-cols-2 gap-2"},Be={key:1,class:"mt-3"},De={key:0,class:"text-sm text-gray-600 dark:text-gray-300"},qe={key:1,class:"flex flex-wrap gap-2"},Ue=["href"],ze={class:"rounded-2xl border bg-white dark:bg-gray-800 p-5"},Ne={class:"flex items-center justify-between mb-3"},Le={key:0,class:"grid grid-cols-1 sm:grid-cols-2 gap-3"},Oe={key:1,class:"text-sm text-gray-600 dark:text-gray-300"},Ee={key:2,class:"grid grid-cols-1 sm:grid-cols-2 gap-3"},He=["onClick"],Pe={class:"flex items-start justify-between gap-3"},Qe={class:"text-base font-semibold text-gray-900 dark:text-white leading-snug"},Ze={class:"mt-2 text-sm text-gray-600 dark:text-gray-300 space-y-1.5"},Ae={class:"space-y-4"},Ge={class:"rounded-2xl border bg-white dark:bg-gray-800 p-5"},Je={class:"mt-3 space-y-2 text-sm text-gray-700 dark:text-gray-300"},Ke={class:"flex justify-between"},Re={class:"font-medium"},We={class:"flex justify-between"},Xe={class:"font-medium"},Ye={class:"flex justify-between"},ts={class:"font-medium"},es={class:"flex justify-between"},ss={class:"font-medium"},as={class:"flex justify-between"},ls={class:"font-medium"},ds={class:"flex justify-between"},os={key:0,class:"space-y-4"},rs={class:"rounded-2xl border bg-white dark:bg-gray-800 p-5"},is={key:1,class:"text-sm text-gray-500 dark:text-gray-400"},ns={key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4"},us={class:"relative w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6"},gs={class:"flex items-center justify-between"},cs={key:0,class:"mt-3 text-sm text-rose-600"},xs=["value"],vs={class:"grid grid-cols-2 gap-4"},ps={class:"flex justify-end gap-2"},ms=["disabled"],ys={key:0},bs={key:1},ws={__name:"Show",setup(F){var N;const{props:_}=Tt(),x=_.id,v=(N=_.auth)==null?void 0:N.user,y=p(!0),s=p(null),f=p(!1),w=p(""),u=p(null),$=d=>{u.value=d.target.files},n=p(!1),C=p([]),c=p({title:"",executor_id:"",start_date:new Date().toISOString().slice(0,10),due_date:""}),ft=I(()=>{var d,e,i;return!s.value||!v?!1:((d=s.value.responsible)==null?void 0:d.id)===v.id||((i=(e=s.value.project)==null?void 0:e.manager)==null?void 0:i.id)===v.id}),q=d=>d==="high"?"bg-rose-100 text-rose-700 ring-1 ring-rose-200":d==="medium"?"bg-amber-100 text-amber-700 ring-1 ring-amber-200":"bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200",U=d=>d==="high"?"Высокая":d==="medium"?"Средняя":"Обычная",T=async()=>{y.value=!0;try{const{data:d}=await m.get(`/api/tasks/${x}`);s.value=d}finally{y.value=!1}},wt=async d=>{try{const{data:e}=await m.patch(`/api/tasks/${x}/progress`,{progress:d});s.value.progress=e.progress}catch{alert("Недостаточно прав для обновления прогресса.")}},$t=async()=>{var e;if(!((e=u.value)!=null&&e.length))return alert("Выберите файлы");const d=new FormData;for(let i=0;i<u.value.length;i++)d.append("files[]",u.value[i]);try{await m.post(`/api/tasks/${x}/files`,d,{headers:{"Content-Type":"multipart/form-data"}}),u.value=null,await T()}catch{alert("Ошибка при загрузке файлов")}},Ct=async()=>{const{data:d}=await m.get(`/api/projects/${s.value.project.id}/employees`);C.value=d,n.value=!0},jt=async()=>{var d,e;f.value=!0,w.value="";try{await m.post(`/api/tasks/${x}/subtasks`,{...c.value,task_id:x}),n.value=!1,c.value={title:"",executor_id:"",start_date:new Date().toISOString().slice(0,10),due_date:""},await T()}catch(i){w.value=((e=(d=i==null?void 0:i.response)==null?void 0:d.data)==null?void 0:e.message)||"Ошибка при создании подзадачи"}finally{f.value=!1}},z=I(()=>{var d;return(((d=s.value)==null?void 0:d.subtasks)||[]).some(e=>!e.completed)}),St=I(()=>{var d,e;return((d=s.value)==null?void 0:d.progress)===100&&!((e=s.value)!=null&&e.completed)&&!z.value}),Vt=async()=>{var d,e;try{const{data:i}=await m.patch(`/api/tasks/${x}/complete`);s.value=i.task}catch(i){const V=((e=(d=i==null?void 0:i.response)==null?void 0:d.data)==null?void 0:e.message)||"Не удалось завершить задачу";alert(V)}},It=I(()=>{var e,i;const d=(i=(e=_.auth)==null?void 0:e.user)==null?void 0:i.id;return!d||!s.value?!1:d===s.value.executor_id||d===s.value.responsible_id});return _t(T),(d,e)=>{var i;return a(),l(h,null,[B(Bt(qt),{title:(i=s.value)!=null&&i.title?`Задача — ${s.value.title}`:"Задача"},null,8,["title"]),B(Lt,null,{default:Dt(()=>{var V,L,O,E,H,P,Q,Z,A,G,J,K,R,W,X,Y,tt,et,st,at,lt,dt,ot,rt,it,nt,ut,gt,ct,xt,vt,pt,mt,yt,bt,ht,kt;return[t("div",te,[e[13]||(e[13]=t("div",{class:"absolute inset-0 bg-gradient-to-r from-sky-600 via-indigo-600 to-fuchsia-600 opacity-90"},null,-1)),t("div",ee,[t("div",se,[t("div",ae,[t("h1",le,r(((V=s.value)==null?void 0:V.title)??"Загрузка…"),1),t("div",de,[t("span",oe,[e[7]||(e[7]=b(" Проект: ",-1)),t("b",null,r(((O=(L=s.value)==null?void 0:L.project)==null?void 0:O.name)??"—"),1)]),t("span",re,[e[8]||(e[8]=b(" Компания: ",-1)),t("b",null,r(((P=(H=(E=s.value)==null?void 0:E.project)==null?void 0:H.company)==null?void 0:P.name)??"—"),1)]),t("span",ie,[e[9]||(e[9]=b(" От: ",-1)),t("b",null,r(((Z=(Q=s.value)==null?void 0:Q.creator)==null?void 0:Z.name)??"—"),1)]),t("span",ne,[e[10]||(e[10]=b(" Кому: ",-1)),t("b",null,r(((G=(A=s.value)==null?void 0:A.executor)==null?void 0:G.name)??"—"),1)]),t("span",ue,[e[11]||(e[11]=b(" Ответственный: ",-1)),t("b",null,r(((K=(J=s.value)==null?void 0:J.responsible)==null?void 0:K.name)??"—"),1)]),s.value?(a(),l("span",{key:0,class:D(["px-2 py-1 rounded-full ring-1 bg-white text-gray-900",q(s.value.priority)])},[e[12]||(e[12]=b(" Приоритет: ",-1)),t("b",null,r(U(s.value.priority)),1)],2)):g("",!0)])]),t("div",ge,[(W=(R=s.value)==null?void 0:R.project)!=null&&W.id?(a(),l("a",{key:0,href:`/projects/${s.value.project.id}`,class:"rounded-xl bg-white text-gray-900 hover:bg-white/90 px-4 py-2 font-medium"}," К проекту ",8,ce)):g("",!0)]),It.value?(a(),l("div",xe,[St.value?(a(),l("button",{key:0,onClick:Vt,class:"px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700",title:"Завершить задачу"}," Завершить задачу ")):((X=s.value)==null?void 0:X.progress)===100&&!((Y=s.value)!=null&&Y.completed)?(a(),l("div",ve,[z.value?(a(),l("span",pe," Есть незавершённые подзадачи — завершите их, чтобы закрыть задачу. ")):g("",!0)])):g("",!0),(tt=s.value)!=null&&tt.completed?(a(),l("div",me," Завершена "+r(((et=s.value)==null?void 0:et.completed_at)||""),1)):g("",!0)])):g("",!0)])])]),t("div",ye,[t("div",be,[t("div",he,[t("div",ke,[t("div",_e,[t("div",null,[e[14]||(e[14]=t("div",{class:"text-xs text-gray-500"},"Дата начала",-1)),t("div",fe,r(((st=s.value)==null?void 0:st.start_date)??"—"),1)]),t("div",null,[e[15]||(e[15]=t("div",{class:"text-xs text-gray-500"},"Дата окончания",-1)),t("div",we,r(((at=s.value)==null?void 0:at.due_date)??"—"),1)]),t("div",null,[e[16]||(e[16]=t("div",{class:"text-xs text-gray-500"},"Прогресс",-1)),t("div",$e,[t("div",Ce,[t("div",{class:"h-2 bg-emerald-500",style:Ut({width:(((lt=s.value)==null?void 0:lt.progress)||0)+"%"})},null,4)]),t("div",je,"Выполнено "+r(((dt=s.value)==null?void 0:dt.progress)??0)+"%",1)]),t("div",Se,[(a(),l(h,null,k(11,o=>{var j;return t("button",{key:o,onClick:Mt=>wt((o-1)*10),class:D(["flex-1 h-5 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300",{"!bg-emerald-500":(((j=s.value)==null?void 0:j.progress)||0)>=(o-1)*10}]),title:`${(o-1)*10}%`},null,10,Ve)}),64))])])])]),t("div",Ie,[t("div",Me,[e[17]||(e[17]=t("h2",{class:"text-lg font-semibold text-gray-900 dark:text-white"},"Файлы",-1)),t("div",Fe,[t("input",{type:"file",multiple:"",onChange:$,accept:".pdf,.doc,.docx,.xls,.xlsx",class:"text-sm text-gray-600 dark:text-gray-300"},null,32),t("button",{onClick:$t,class:"rounded-xl bg-indigo-600 text-white px-4 py-2 hover:bg-indigo-700"}," Загрузить ")])]),y.value?(a(),l("div",Te,[(a(),l(h,null,k(4,o=>t("div",{key:o,class:"h-8 rounded-lg bg-gray-200 dark:bg-gray-700 animate-pulse"})),64))])):(a(),l("div",Be,[(rt=(ot=s.value)==null?void 0:ot.files)!=null&&rt.length?(a(),l("div",qe,[(a(!0),l(h,null,k(s.value.files,o=>(a(),l("a",{key:o.id,href:`/storage/${o.file_path}`,target:"_blank",class:"inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100"},[e[18]||(e[18]=t("svg",{class:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12V8l-4-6zM6 22V4h7v5h5v13H6z"})],-1)),b(" "+r(o.file_path.split("/").pop()),1)],8,Ue))),128))])):(a(),l("div",De," Файлы не прикреплены. "))]))]),t("div",ze,[t("div",Ne,[e[19]||(e[19]=t("h2",{class:"text-lg font-semibold text-gray-900 dark:text-white"},"Подзадачи",-1)),ft.value?(a(),l("button",{key:0,onClick:Ct,class:"rounded-xl bg-emerald-600 text-white px-4 py-2 hover:bg-emerald-700"}," + Подзадача ")):g("",!0)]),y.value?(a(),l("div",Le,[(a(),l(h,null,k(4,o=>t("div",{key:o,class:"rounded-xl border p-4 animate-pulse"},e[20]||(e[20]=[t("div",{class:"h-4 w-1/2 bg-gray-200 dark:bg-gray-700 rounded mb-3"},null,-1),t("div",{class:"h-3 w-2/3 bg-gray-200 dark:bg-gray-700 rounded mb-2"},null,-1),t("div",{class:"h-3 w-1/2 bg-gray-200 dark:bg-gray-700 rounded"},null,-1)]))),64))])):(nt=(it=s.value)==null?void 0:it.subtasks)!=null&&nt.length?(a(),l("div",Ee,[(a(!0),l(h,null,k(s.value.subtasks,o=>{var j;return a(),l("div",{key:o.id,class:"group rounded-xl border p-4 bg-white dark:bg-gray-800 hover:shadow-md transition cursor-pointer",onClick:Mt=>d.$inertia.visit(`/subtasks/${o.id}`)},[t("div",Pe,[t("h3",Qe,r(o.title),1)]),t("div",Ze,[t("div",null,[e[21]||(e[21]=b("Исполнитель: ",-1)),t("b",null,r(((j=o.executor)==null?void 0:j.name)??"—"),1)]),t("div",null,"Сроки: "+r(o.start_date)+" — "+r(o.due_date),1)])],8,He)}),128))])):(a(),l("div",Oe," Подзадач пока нет. "))])]),t("div",Ae,[t("div",Ge,[e[28]||(e[28]=t("h3",{class:"text-sm font-semibold text-gray-900 dark:text-white"},"Кратко о задаче",-1)),t("dl",Je,[t("div",Ke,[e[22]||(e[22]=t("dt",null,"Автор",-1)),t("dd",Re,r(((gt=(ut=s.value)==null?void 0:ut.creator)==null?void 0:gt.name)??"—"),1)]),t("div",We,[e[23]||(e[23]=t("dt",null,"Исполнитель",-1)),t("dd",Xe,r(((xt=(ct=s.value)==null?void 0:ct.executor)==null?void 0:xt.name)??"—"),1)]),t("div",Ye,[e[24]||(e[24]=t("dt",null,"Ответственный",-1)),t("dd",ts,r(((pt=(vt=s.value)==null?void 0:vt.responsible)==null?void 0:pt.name)??"—"),1)]),t("div",es,[e[25]||(e[25]=t("dt",null,"Проект",-1)),t("dd",ss,r(((yt=(mt=s.value)==null?void 0:mt.project)==null?void 0:yt.name)??"—"),1)]),t("div",as,[e[26]||(e[26]=t("dt",null,"Компания",-1)),t("dd",ls,r(((kt=(ht=(bt=s.value)==null?void 0:bt.project)==null?void 0:ht.company)==null?void 0:kt.name)??"—"),1)]),t("div",ds,[e[27]||(e[27]=t("dt",null,"Приоритет",-1)),t("dd",null,[s.value?(a(),l("span",{key:0,class:D(["px-2 py-1 text-xs rounded-full ring-1",q(s.value.priority)])},r(U(s.value.priority)),3)):g("",!0)])])])])]),s.value?(a(),l("div",os,[t("div",rs,[e[29]||(e[29]=t("h3",{class:"text-sm font-semibold text-gray-900 dark:text-white"},"Кратко о задаче",-1)),B(Yt,{"task-id":s.value.id,"can-chat":!0},null,8,["task-id"])])])):(a(),l("div",is,"Загрузка…"))])]),n.value?(a(),l("div",ns,[t("div",{class:"absolute inset-0 bg-black/50",onClick:e[0]||(e[0]=o=>n.value=!1)}),t("div",us,[t("div",gs,[e[30]||(e[30]=t("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white"},"Новая подзадача",-1)),t("button",{onClick:e[1]||(e[1]=o=>n.value=!1),class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"},"✕")]),w.value?(a(),l("p",cs,r(w.value),1)):g("",!0),t("form",{class:"mt-4 space-y-4",onSubmit:zt(jt,["prevent"])},[t("div",null,[e[31]||(e[31]=t("label",{class:"block text-sm mb-1 text-gray-700 dark:text-gray-300"},"Название",-1)),S(t("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>c.value.title=o),class:"w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-700 dark:text-white",required:""},null,512),[[M,c.value.title]])]),t("div",null,[e[33]||(e[33]=t("label",{class:"block text-sm mb-1 text-gray-700 dark:text-gray-300"},"Исполнитель",-1)),S(t("select",{"onUpdate:modelValue":e[3]||(e[3]=o=>c.value.executor_id=o),class:"w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-700 dark:text-white",required:""},[e[32]||(e[32]=t("option",{disabled:"",value:""},"Выберите сотрудника",-1)),(a(!0),l(h,null,k(C.value,o=>(a(),l("option",{key:o.id,value:o.id},r(o.name),9,xs))),128))],512),[[Nt,c.value.executor_id]])]),t("div",vs,[t("div",null,[e[34]||(e[34]=t("label",{class:"block text-sm mb-1 text-gray-700 dark:text-gray-300"},"Начало",-1)),S(t("input",{type:"date","onUpdate:modelValue":e[4]||(e[4]=o=>c.value.start_date=o),class:"w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-700 dark:text-white",required:""},null,512),[[M,c.value.start_date]])]),t("div",null,[e[35]||(e[35]=t("label",{class:"block text-sm mb-1 text-gray-700 dark:text-gray-300"},"Окончание",-1)),S(t("input",{type:"date","onUpdate:modelValue":e[5]||(e[5]=o=>c.value.due_date=o),class:"w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-700 dark:text-white",required:""},null,512),[[M,c.value.due_date]])])]),t("div",ps,[t("button",{type:"button",onClick:e[6]||(e[6]=o=>n.value=!1),class:"px-4 py-2 rounded-xl border bg-white dark:bg-gray-700 dark:text-white"},"Отмена"),t("button",{type:"submit",disabled:f.value,class:"px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60"},[f.value?(a(),l("span",bs,"Сохраняю…")):(a(),l("span",ys,"Создать"))],8,ms)])],32)])])):g("",!0)]}),_:1})],64)}}};export{ws as default};
