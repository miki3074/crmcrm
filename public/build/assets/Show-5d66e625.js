import{R as G,h as f,c as J,z as K,o as $,a as b,m as p,u as T,M as L,F as X,j as r,Z as Y,b as m}from"./app-12bccec5.js";import{_ as ee}from"./AuthenticatedLayout-68445c6f.js";import ae from"./TaskHero-b03bb560.js";import se from"./TaskStats-cf7f5d92.js";import te from"./TaskSubtasks-1191036d.js";import oe from"./TaskSidebar-2876546b.js";import"./TaskChat-bb51f01a.js";import ne from"./TaskActionModals-7dd8b722.js";import re from"./TaskPersonnelModals-d711195e.js";import le from"./TaskDocumentApproval-3ef97d1b.js";import"./ApplicationLogo-b144d97d.js";import"./_plugin-vue_export-helper-c27b6911.js";const ie={key:0},ue={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10 -mt-4"},de={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},pe={class:"lg:col-span-2 space-y-6"},ce={class:"bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700"},ve={class:"lg:col-span-1"},me={key:1,class:"text-center py-20 text-gray-500"},Re={__name:"Show",setup(ke){var x;const{props:y}=G(),l=y.id,v=(x=y.auth)==null?void 0:x.user,s=f(null),g=f([]),k=f(!0),o=f({edit:!1,description:!1,delete:!1,subtask:!1,executor:!1,responsible:!1,addExecutor:!1,addResponsible:!1,addWatcher:!1,manage:!1}),w=J(()=>{var h,_,C,j,D,R,E,F,M,S;if(!s.value)return{};const a=v.id===((_=(h=s.value.project)==null?void 0:h.company)==null?void 0:_.user_id),e=v.id===((C=s.value.creator)==null?void 0:C.id),n=(j=s.value.executors)==null?void 0:j.some(d=>d.id===v.id),t=(D=s.value.responsibles)==null?void 0:D.some(d=>d.id===v.id),c=(E=(R=s.value.project)==null?void 0:R.executors)==null?void 0:E.some(d=>d.id===v.id),u=(M=(F=s.value.project)==null?void 0:F.managers)==null?void 0:M.some(d=>d.id===v.id),Z=e||n||t,q=a||u||c;return{canCreateSubtask:a||e||t||n||u||c,canUpdate:a||u||c,canDelete:a||u||c,canUpload:n||t||c||a,canFinish:s.value.progress===100&&!s.value.completed&&!((S=s.value.subtasks)!=null&&S.some(d=>!d.completed)),canManageMembers:q,canManageTask:Z}}),i=async()=>{k.value=!0;try{const{data:a}=await r.get(`/api/tasks/${l}`);s.value=a;const e=await r.get(`/api/projects/${a.project.id}/employees`);g.value=e.data}catch(a){console.error(a)}finally{k.value=!1}},A=async a=>{await r.put(`/api/tasks/${l}`,a),o.value.edit=!1,await i()},P=async a=>{await r.patch(`/api/tasks/${l}/description`,{description:a}),o.value.description=!1,await i()},U=async a=>{await r.patch(`/api/tasks/${l}/progress`,{progress:a}),s.value.progress=a},W=async()=>{await r.delete(`/api/tasks/${l}`),window.history.back()},B=async()=>{await r.patch(`/api/tasks/${l}/complete`),await i()},I=async a=>{const e=new FormData;for(let n=0;n<a.length;n++)e.append("files[]",a[n]);await r.post(`/api/tasks/${l}/files`,e),await i()},N=async a=>{confirm("Удалить?")&&(await r.delete(`/api/tasks/files/${a}`),await i())},V=async a=>{await r.post(`/api/tasks/${l}/subtasks`,a),o.value.subtask=!1,await i()},z=async({type:a,oldId:e,newId:n})=>{const t=a==="executor"?"executor":"responsible";await r.patch(`/api/tasks/${l}/${t}`,{replace_user_id:e,user_id:n}),o.value[a]=!1,await i()},H=async({type:a,ids:e,singleId:n})=>{if(a==="watcher")await r.post(`/api/tasks/${l}/watchers`,{user_id:n}),o.value.addWatcher=!1;else{const t=a==="executor"?"executors":"responsibles";await r.post(`/api/tasks/${l}/${t}/add`,{user_ids:e}),o.value["add"+a.charAt(0).toUpperCase()+a.slice(1)]=!1}await i()},O=async({role:a,id:e})=>{const n=a==="watcherstask"?"watchers":a;await r.delete(`/api/tasks/${l}/${n}`,{data:{user_id:e}}),await i()},Q=async a=>{var n,t,c;const e=a||((n=s.value)==null?void 0:n.id)||l;if(!e){console.error("ID задачи не найден");return}try{const{data:u}=await r.post(`/api/tasks/${e}/start`);s.value=u.task}catch(u){console.error(u),alert(((c=(t=u.response)==null?void 0:t.data)==null?void 0:c.message)||"Ошибка")}};return K(i),(a,e)=>{var n;return $(),b(X,null,[p(T(Y),{title:((n=s.value)==null?void 0:n.title)||"Задача"},null,8,["title"]),p(ee,null,{default:L(()=>[!k.value&&s.value?($(),b("div",ie,[p(ae,{task:s.value,perms:w.value,onStartWork:Q,onEdit:e[0]||(e[0]=t=>o.value.edit=!0),onDelete:e[1]||(e[1]=t=>o.value.delete=!0),onDescription:e[2]||(e[2]=t=>o.value.description=!0),onBack:e[3]||(e[3]=()=>a.$inertia.visit(`/projects/${s.value.project_id}`)),onFinish:B,onChangeExecutor:e[4]||(e[4]=t=>o.value.executor=!0),onChangeResponsible:e[5]||(e[5]=t=>o.value.responsible=!0),onAddExecutor:e[6]||(e[6]=t=>o.value.addExecutor=!0),onAddResponsible:e[7]||(e[7]=t=>o.value.addResponsible=!0),onAddWatcher:e[8]||(e[8]=t=>o.value.addWatcher=!0),onManageMembers:e[9]||(e[9]=t=>o.value.manage=!0)},null,8,["task","perms"]),m("div",ue,[m("div",de,[m("div",pe,[p(se,{task:s.value,loading:k.value,"can-upload":w.value.canUpload,onUpdateProgress:U,onUploadFiles:I,onDeleteFile:N},null,8,["task","loading","can-upload"]),m("div",ce,[p(le,{task:s.value,"current-user":T(v),onRefresh:i},null,8,["task","current-user"])]),p(te,{subtasks:s.value.subtasks,"can-create":w.value.canCreateSubtask,onCreate:e[10]||(e[10]=t=>o.value.subtask=!0)},null,8,["subtasks","can-create"])]),m("div",ve,[p(oe,{task:s.value},null,8,["task"])])])])])):($(),b("div",me,"Загрузка задачи...")),p(ne,{modals:o.value,task:s.value,employees:g.value,onClose:e[11]||(e[11]=t=>o.value[t]=!1),onUpdate:A,onSaveDescription:P,onDeleteTask:W,onCreateSubtask:V},null,8,["modals","task","employees"]),p(re,{modals:o.value,task:s.value,employees:g.value,onClose:e[12]||(e[12]=t=>o.value[t]=!1),onChange:z,onAdd:H,onRemove:O},null,8,["modals","task","employees"])]),_:1})],64)}}};export{Re as default};
