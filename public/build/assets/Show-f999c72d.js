import{R as J,h as f,c as K,z as L,o as $,a as b,m as p,u as S,M as X,F as Y,j as l,Z as ee,b as m,f as A}from"./app-9a2dd688.js";import{_ as ae}from"./AuthenticatedLayout-57faf720.js";import se from"./TaskHero-655a1b8f.js";import te from"./TaskStats-ef0f8b84.js";import oe from"./TaskSubtasks-8be92534.js";import ne from"./TaskSidebar-bf56c069.js";import"./TaskChat-e368bebc.js";import le from"./TaskActionModals-bc3baa1c.js";import re from"./TaskPersonnelModals-7c10b5e4.js";import ie from"./TaskDocumentApproval-4f01117d.js";import"./ApplicationLogo-f81164ff.js";import"./_plugin-vue_export-helper-c27b6911.js";const ue={key:0},de={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10 -mt-4"},pe={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},ce={class:"lg:col-span-2 space-y-6"},ve={class:"bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700"},me={class:"lg:col-span-1"},ke={key:1,class:"text-center py-20 text-gray-500"},Ee={__name:"Show",setup(fe){var x;const{props:y}=J(),r=y.id,v=(x=y.auth)==null?void 0:x.user,s=f(null),g=f([]),k=f(!0),o=f({edit:!1,description:!1,delete:!1,subtask:!1,executor:!1,responsible:!1,addExecutor:!1,addResponsible:!1,addWatcher:!1,manage:!1}),w=K(()=>{var h,_,C,j,D,R,E,F,T,M;if(!s.value)return{};const a=v.id===((_=(h=s.value.project)==null?void 0:h.company)==null?void 0:_.user_id),e=v.id===((C=s.value.creator)==null?void 0:C.id),n=(j=s.value.executors)==null?void 0:j.some(d=>d.id===v.id),t=(D=s.value.responsibles)==null?void 0:D.some(d=>d.id===v.id),c=(E=(R=s.value.project)==null?void 0:R.executors)==null?void 0:E.some(d=>d.id===v.id),u=(T=(F=s.value.project)==null?void 0:F.managers)==null?void 0:T.some(d=>d.id===v.id),q=e||n||t,G=a||u||c;return{canCreateSubtask:a||e||t||n||u||c,canUpdate:a||u||c,canDelete:a||u||c,canUpload:n||t||c||a,canFinish:s.value.progress===100&&!s.value.completed&&!((M=s.value.subtasks)!=null&&M.some(d=>!d.completed)),canManageMembers:G,canManageTask:q}}),i=async()=>{k.value=!0;try{const{data:a}=await l.get(`/api/tasks/${r}`);s.value=a;const e=await l.get(`/api/projects/${a.project.id}/employees`);g.value=e.data}catch(a){console.error(a)}finally{k.value=!1}},P=async a=>{await l.put(`/api/tasks/${r}`,a),o.value.edit=!1,await i()},U=async a=>{await l.patch(`/api/tasks/${r}/description`,{description:a}),o.value.description=!1,await i()},W=async a=>{await l.patch(`/api/tasks/${r}/progress`,{progress:a}),s.value.progress=a},B=async()=>{await l.delete(`/api/tasks/${r}`),window.history.back()},N=async()=>{await l.patch(`/api/tasks/${r}/complete`),await i()},V=async a=>{const e=new FormData;for(let n=0;n<a.length;n++)e.append("files[]",a[n]);await l.post(`/api/tasks/${r}/files`,e),await i()},I=async a=>{confirm("Удалить?")&&(await l.delete(`/api/tasks/files/${a}`),await i())},z=async a=>{await l.post(`/api/tasks/${r}/subtasks`,a),o.value.subtask=!1,await i()},H=async({type:a,oldId:e,newId:n})=>{const t=a==="executor"?"executor":"responsible";await l.patch(`/api/tasks/${r}/${t}`,{replace_user_id:e,user_id:n}),o.value[a]=!1,await i()},O=async({type:a,ids:e,singleId:n})=>{if(a==="watcher")await l.post(`/api/tasks/${r}/watchers`,{user_id:n}),o.value.addWatcher=!1;else{const t=a==="executor"?"executors":"responsibles";await l.post(`/api/tasks/${r}/${t}/add`,{user_ids:e}),o.value["add"+a.charAt(0).toUpperCase()+a.slice(1)]=!1}await i()},Q=async({role:a,id:e})=>{const n=a==="watcherstask"?"watchers":a;await l.delete(`/api/tasks/${r}/${n}`,{data:{user_id:e}}),await i()},Z=async a=>{var n,t,c;const e=a||((n=s.value)==null?void 0:n.id)||r;if(!e){console.error("ID задачи не найден");return}try{const{data:u}=await l.post(`/api/tasks/${e}/start`);s.value=u.task}catch(u){console.error(u),alert(((c=(t=u.response)==null?void 0:t.data)==null?void 0:c.message)||"Ошибка")}};return L(i),(a,e)=>{var n;return $(),b(Y,null,[p(S(ee),{title:((n=s.value)==null?void 0:n.title)||"Задача"},null,8,["title"]),p(ae,null,{default:X(()=>[!k.value&&s.value?($(),b("div",ue,[p(se,{task:s.value,perms:w.value,onStartWork:Z,onEdit:e[0]||(e[0]=t=>o.value.edit=!0),onDelete:e[1]||(e[1]=t=>o.value.delete=!0),onDescription:e[2]||(e[2]=t=>o.value.description=!0),onBack:e[3]||(e[3]=()=>a.$inertia.visit(`/projects/${s.value.project_id}`)),onFinish:N,onChangeExecutor:e[4]||(e[4]=t=>o.value.executor=!0),onChangeResponsible:e[5]||(e[5]=t=>o.value.responsible=!0),onAddExecutor:e[6]||(e[6]=t=>o.value.addExecutor=!0),onAddResponsible:e[7]||(e[7]=t=>o.value.addResponsible=!0),onAddWatcher:e[8]||(e[8]=t=>o.value.addWatcher=!0),onManageMembers:e[9]||(e[9]=t=>o.value.manage=!0)},null,8,["task","perms"]),m("div",de,[m("div",pe,[m("div",ce,[p(te,{task:s.value,loading:k.value,"can-upload":w.value.canUpload,onUpdateProgress:W,onUploadFiles:V,onDeleteFile:I},null,8,["task","loading","can-upload"]),m("div",ve,[p(ie,{task:s.value,"current-user":S(v),onRefresh:i},null,8,["task","current-user"])]),p(oe,{subtasks:s.value.subtasks,"can-create":w.value.canCreateSubtask,onCreate:e[10]||(e[10]=t=>o.value.subtask=!0)},null,8,["subtasks","can-create"])]),m("div",me,[p(ne,{task:s.value},null,8,["task"])])])])])):($(),b("div",ke,e[13]||(e[13]=[A("Загрузка задачи... ",-1),m("br",null,null,-1),A(" нет доступа к этой задаче ",-1)]))),p(le,{modals:o.value,task:s.value,employees:g.value,onClose:e[11]||(e[11]=t=>o.value[t]=!1),onUpdate:P,onSaveDescription:U,onDeleteTask:B,onCreateSubtask:z},null,8,["modals","task","employees"]),p(re,{modals:o.value,task:s.value,employees:g.value,onClose:e[12]||(e[12]=t=>o.value[t]=!1),onChange:H,onAdd:O,onRemove:Q},null,8,["modals","task","employees"])]),_:1})],64)}}};export{Ee as default};
